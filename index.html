<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Territorios Marindia</title>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- (Opcional) Leaflet.Draw CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"
    />

    <style>
      #map {
        height: 900px;
        width: 100%;
      }
      #info-panel {
        position: fixed;
        width: 10%;
        top: 50%;
        left: 50px;
        height: 10%;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        font-family: Arial, sans-serif;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .label {
        font-size: 14px;
        font-weight: bold;
        background: #fff;
        padding: 2px;
        border-radius: 5px;
      }
      .tooltip-content {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .hidden {
        display: none;
      }

      #referencias,
      #ranking-container,
      #contador-poligonos {
        position: fixed;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        font-family: Arial, sans-serif;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      #referencias {
        top: 10px;
        left: 50px;
        width: 250px;
        max-height: 400px;
        overflow-y: auto;
      }
      #ranking-container {
        top: 10px;
        right: 10px;
        width: 250px;
        max-height: 400px;
        overflow-y: auto;
      }
      #contador-poligonos {
        bottom: 10px;
        right: 10px;
        width: 250px;
        max-height: 400px;
        overflow-y: auto;
      }

      .referencias {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 0;
      }
      .referencia {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .color-box {
        width: 20px;
        height: 20px;
        border: 1px solid #000;
      }
      .azul {
        background: rgb(9, 0, 128);
      }
      .verde {
        background: green;
      }
      .amarillo {
        background: yellow;
      }
      .rojo {
        background: red;
      }

      #ranking-container h3 {
        font-size: 16px;
        margin-bottom: 10px;
        text-align: center;
        border-bottom: 1px solid #fff;
        padding-bottom: 5px;
      }
      #ranking-container ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      #ranking-container li {
        font-size: 14px;
        margin: 5px 0;
      }
       #toggle-referencias {
        position: fixed;
        bottom: 80px;
        left: 10px;
        padding: 10px 15px;
        background: #000;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1100;
        display: none; /* Oculto por defecto */
      }

      /*=== Estilo Responsivo=== */
      @media (max-width: 768px) {
        #referencias,
        #ranking-container,
        #contador-poligonos,
        #info-panel {
          display: none;
        }

        #referencias {
          right: 10px;
          font-size: 10px;
          width: 150px;
          top: 10px;
          left: auto;
        }
        .color-box {
          width: 10px;
          height: 10px;
        }

        #ranking-container {
          width: 150px;
          top: 180px;
        }
        #ranking-container li {
          font-size: 10px;
          margin: 4px 0;
        }

        #info-panel {
          width: 150px;
          right: 10px;
          top: 590px;
          height: auto;
          font-size: 10px;
        }

        #contador-poligonos {
          width: 150px;
          font-size: 10px;
          top: 680px;
        }

        #toggle-referencias {
          display: block;
          top: 100px;
          height: 50px;
        }

        /* Animación de escala */
        @keyframes scaleDown {
          0% {
            transform: scale(1);
          }
          50% {
            transform: scale(0.9);
          }
          100% {
            transform: scale(1);
          }
        }

        #toggle-referencias.animate {
          animation: scaleDown 200ms ease-in-out;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="info-panel">
      <p><strong>Territorio:</strong> <span id="polygon-id"></span></p>
      <p><strong>Última visita:</strong> <span id="polygon-fecha"></span></p>
    </div>

    <div id="referencias">
      <h3 style="margin-top: 0">Referencias</h3>
      <div class="referencias">
        <div class="referencia">
          <div class="color-box azul"></div>
          <span>Se está trabajando</span>
        </div>
        <div class="referencia">
          <div class="color-box verde"></div>
          <span>Menos de 2 meses (finalizado)</span>
        </div>
        <div class="referencia">
          <div class="color-box amarillo"></div>
          <span>Más de 2 y menos de 3 meses</span>
        </div>
        <div class="referencia">
          <div class="color-box rojo"></div>
          <span>3 meses o más</span>
        </div>
      </div>
    </div>

    <div id="contador-poligonos">
      <h3>Estado de territorios</h3>
      <p>Trabajando: <span id="contador-azul">0</span></p>
      <p>Realizados: <span id="contador-verde">0</span></p>
      <p>Realizar: <span id="contador-amarillo">0</span></p>
      <p>Urgentes: <span id="contador-rojo">0</span></p>
    </div>

    <div id="ranking-container"></div>
    <button id="toggle-referencias">📋 Ver Información</button>"
    <script>
      /*************** CONFIG ***************/
      const SHEET_CSV =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDOYlDoIJ04iSCXs-p5M3n8iATEX1Jlgn6i1WuwcUhe7JBCbPiE82k1HpyaMl1L8Ys-7HIfAcz3L_U/pub?gid=1159469350&single=true&output=csv";

      const N_RANK = 20;
      let contadores = { blue: 0, green: 0, yellow: 0, red: 0 };

      /*************** MAPA ***************/
      const map = L.map("map").setView([-34.77118, -55.826602], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      /*************** POLÍGONOS (tu dataset) ***************/
      var poligonos = [
        {
          id: "32",
          coords: [
            [-34.77523113048178, -55.84001898765565],
            [-34.776833923149596, -55.83947181701661],
            [-34.77606775691245, -55.83539485931397],
            [-34.77440330229577, -55.83585619926453],
          ],
        },
        {
          id: "34",
          coords: [
            [-34.776859558820625, -55.83947181701661],
            [-34.77990653939457, -55.83864569664002],
            [-34.77955429305767, -55.83659648895264],
            [-34.776489686467926, -55.83744406700135],
          ],
        },
        {
          id: "33",
          coords: [
            [-34.776498492971776, -55.83741188049317],
            [-34.77607577972638, -55.83539485931397],
            [-34.777176590946105, -55.83498716354371],
            [-34.77918443278533, -55.83449363708496],
            [-34.779545486879975, -55.836575031280525],
          ],
        },
        {
          id: "36",
          coords: [
            [-34.77991767269939, -55.83863496780396],
            [-34.77955662023356, -55.836575031280525],
            [-34.78056051830043, -55.836328268051155],
            [-34.780710221351455, -55.83697199821473],
            [-34.78087753620467, -55.83701491355897],
            [-34.78130022484858, -55.836542844772346],
            [-34.7816876875363, -55.836317539215095],
            [-34.78216320743851, -55.83676815032959],
            [-34.782444995716716, -55.83698272705079],
            [-34.782885287974416, -55.83696126937867],
            [-34.78308782162379, -55.837841033935554],
          ],
        },
        {
          id: "35",
          coords: [
            [-34.77956542641007, -55.836553573608406],
            [-34.77919556618763, -55.83448290824891],
            [-34.78215440153929, -55.83366751670838],
            [-34.782885287974416, -55.83696126937867],
            [-34.78247141331844, -55.83700418472291],
            [-34.7816876875363, -55.836285352706916],
            [-34.78124738888655, -55.836542844772346],
            [-34.78087753620467, -55.83702564239503],
            [-34.780710221351455, -55.8369505405426],
            [-34.78056051830043, -55.836296081542976],
          ],
        },
        {
          id: "31",
          coords: [
            [-34.774413652592486, -55.835845470428474],
            [-34.773814793058094, -55.83251953125001],
            [-34.77549687276834, -55.832101106643684],
            [-34.77607810700038, -55.835362672805786],
          ],
        },
        {
          id: "29",
          coords: [
            [-34.77608691354818, -55.835373401641846],
            [-34.775690617967285, -55.83321690559388],
            [-34.7788168980516, -55.83239078521729],
            [-34.779177953754704, -55.83449363708496],
            [-34.77715249889255, -55.83496570587159],
          ],
        },
        {
          id: "28",
          coords: [
            [-34.77919556618763, -55.83447217941285],
            [-34.77882570430707, -55.83239078521729],
            [-34.78167007563541, -55.83165049552918],
            [-34.78213678973805, -55.83366751670838],
          ],
        },
        {
          id: "30",
          coords: [
            [-34.77780417240409, -55.83263754844666],
            [-34.77753117466761, -55.83135008811951],
            [-34.7768266602066, -55.83124279975892],
            [-34.77611333318588, -55.83139300346375],
            [-34.7754792595459, -55.831875801086426],
            [-34.77570823114463, -55.83321690559388],
          ],
        },
        {
          id: "37",
          coords: [
            [-34.772073824311626, -55.84090948104859],
            [-34.774821554957406, -55.84009408950806],
            [-34.77429315232354, -55.837583541870124],
            [-34.771510175947284, -55.83835601806641],
          ],
        },
        {
          id: "47",
          coords: [
            [-34.77156301814497, -55.838313102722175],
            [-34.7712811926996, -55.83668231964112],
            [-34.77395849557197, -55.835888385772705],
            [-34.77427553884412, -55.83760499954224],
          ],
        },
        {
          id: "48",
          coords: [
            [-34.77395849557197, -55.835845470428474],
            [-34.77367667830739, -55.83425760269166],
            [-34.77094652373315, -55.83500862121583],
            [-34.77126357857728, -55.83670377731324],
          ],
        },
        {
          id: "38",
          coords: [
            [-34.77203859640164, -55.84095239639282],
            [-34.7698544366132, -55.841531753540046],
            [-34.769801593321525, -55.84101676940919],
            [-34.7699072798711, -55.83998680114747],
            [-34.77027718172879, -55.839300155639656],
            [-34.770752767395436, -55.83872079849244],
            [-34.771527790016926, -55.83842039108277],
          ],
        },
        {
          id: "39",
          coords: [
            [-34.7698544366132, -55.841531753540046],
            [-34.76846288531253, -55.84189653396607],
            [-34.76835719691332, -55.84110260009766],
            [-34.768445270588735, -55.84020137786866],
            [-34.76863903234377, -55.83919286727906],
            [-34.768938481434134, -55.839064121246345],
            [-34.76929077309062, -55.838828086853034],
            [-34.77015388129377, -55.839536190032966],
            [-34.769872051036266, -55.83998680114747],
            [-34.76978397888342, -55.84101676940919],
          ],
        },
        {
          id: "45",
          coords: [
            [-34.771510175947284, -55.83835601806641],
            [-34.771210736187875, -55.83659648895264],
            [-34.770400481979614, -55.83700418472291],
            [-34.76951976186096, -55.83769083023072],
            [-34.76923792943802, -55.838077068328865],
            [-34.769308387633984, -55.838549137115486],
            [-34.769308387633984, -55.838806629180915],
            [-34.77011865256422, -55.83951473236085],
            [-34.77069992467894, -55.83869934082031],
          ],
        },
        {
          id: "46",
          coords: [
            [-34.76938800005783, -55.83775520324708],
            [-34.76900047960947, -55.83552360534669],
            [-34.77094687075189, -55.83503007888794],
            [-34.77121989027271, -55.836660861969],
            [-34.77056816475997, -55.83688616752625],
          ],
        },
        {
          id: "44",
          coords: [
            [-34.76934396373487, -55.83776593208314],
            [-34.76895644307979, -55.83555579185486],
            [-34.76593548104996, -55.83639264106751],
            [-34.76671935645608, -55.84070563316346],
            [-34.768366351314675, -55.84022283554078],
            [-34.768639379372196, -55.83917140960694],
            [-34.768516076490336, -55.838860273361206],
            [-34.768454424980284, -55.83848476409913],
            [-34.76860414999617, -55.83810925483704],
            [-34.7688507553126, -55.83802342414857],
            [-34.76913258905766, -55.838034152984626],
          ],
        },
        {
          id: "40",
          coords: [
            [-34.76698358244349, -55.8422076702118],
            [-34.76674577909287, -55.8407485485077],
            [-34.76834873657026, -55.840340852737434],
            [-34.768295892314505, -55.84123134613038],
            [-34.7684015807922, -55.84190726280213],
          ],
        },
        {
          id: "41",
          coords: [
            [-34.764279629878736, -55.84298014640809],
            [-34.76693954483765, -55.84222912788392],
            [-34.76649916748711, -55.839911699295044],
            [-34.76380400691232, -55.84067344665528],
          ],
        },
        {
          id: "43",
          coords: [
            [-34.76649035991613, -55.83989024162293],
            [-34.765838597055904, -55.83638191223145],
            [-34.764561479232334, -55.83672523498536],
            [-34.76516921362632, -55.840297937393196],
          ],
        },
        {
          id: "42",
          coords: [
            [-34.76379519905376, -55.84066271781922],
            [-34.763134606983726, -55.837100744247444],
            [-34.76454386367591, -55.83673596382142],
            [-34.76514279048486, -55.840297937393196],
          ],
        },
        {
          id: "56",
          coords: [
            [-34.763152222840844, -55.837047100067146],
            [-34.762614937507024, -55.834096670150764],
            [-34.764006587399706, -55.83367824554444],
            [-34.76451744033427, -55.83673596382142],
          ],
        },
        {
          id: "55",
          coords: [
            [-34.76454386367591, -55.8367145061493],
            [-34.765838597055904, -55.836349725723274],
            [-34.76531013690471, -55.833345651626594],
            [-34.76401539523571, -55.8336889743805],
          ],
        },
        {
          id: "54",
          coords: [
            [-34.765838597055904, -55.836349725723274],
            [-34.767133310127555, -55.83595275878907],
            [-34.76658724314517, -55.83299160003663],
            [-34.76531013690471, -55.833356380462654],
          ],
        },
        {
          id: "53",
          coords: [
            [-34.767159732631825, -55.83594202995301],
            [-34.768366351314675, -55.83562016487122],
            [-34.76780267762908, -55.83259463310242],
            [-34.76658724314517, -55.83298087120057],
          ],
        },
        {
          id: "52",
          coords: [
            [-34.768366351314675, -55.83560943603516],
            [-34.76957295235764, -55.835298299789436],
            [-34.76902690151605, -55.83226203918458],
            [-34.76780267762908, -55.832605361938484],
          ],
        },
        {
          id: "51",
          coords: [
            [-34.76906213071162, -55.83226203918458],
            [-34.769581759599674, -55.835309028625495],
            [-34.77091164236083, -55.83495497703553],
            [-34.77035679321809, -55.83192944526673],
          ],
        },
        {
          id: "49",
          coords: [
            [-34.77091829554997, -55.83494424819947],
            [-34.7706276607734, -55.83342075347901],
            [-34.77341947374362, -55.83269119262696],
            [-34.77367487147655, -55.8342468738556],
          ],
        },
        {
          id: "50",
          coords: [
            [-34.77064527503143, -55.83339929580689],
            [-34.770354639293366, -55.83192944526673],
            [-34.77315526836048, -55.83119988441468],
            [-34.77340186007772, -55.83269119262696],
          ],
        },
        {
          id: "57",
          coords: [
            [-34.76497141083696, -55.83336710929871],
            [-34.76483048698029, -55.83253026008607],
            [-34.76527968093466, -55.832412242889404],
            [-34.76526206553151, -55.83219766616822],
            [-34.767182122346924, -55.83052396774293],
            [-34.767525614039755, -55.83265900611878],
          ],
        },
        {
          id: "58",
          coords: [
            [-34.767525614039755, -55.83265900611878],
            [-34.76716450734977, -55.83050251007081],
            [-34.767992408151535, -55.8297622203827],
            [-34.76863534666247, -55.830813646316535],
            [-34.769207821943276, -55.83125352859498],
            [-34.76980671491013, -55.83152174949647],
            [-34.770705046211816, -55.83175778388978],
          ],
        },
        {
          id: "60",
          coords: [
            [-34.77118943648329, -55.83168268203736],
            [-34.77107494449388, -55.82945108413696],
            [-34.772765886955604, -55.829054117202766],
            [-34.77312696913772, -55.83115696907044],
          ],
        },
        {
          id: "59",
          coords: [
            [-34.76856808294956, -55.83069562911988],
            [-34.767995645114425, -55.82978367805481],
            [-34.76928191196875, -55.82857131958008],
            [-34.76981552212723, -55.829043388366706],
            [-34.770326339110206, -55.829333066940315],
            [-34.77107494449388, -55.82945108413696],
            [-34.7711718223414, -55.83165049552918],
            [-34.77079311738174, -55.8317255973816],
            [-34.77027349612064, -55.83165049552918],
            [-34.769701028231786, -55.83146810531617],
            [-34.76921662922429, -55.83125352859498],
          ],
        },
        {
          id: "64",
          coords: [
            [-34.765270873233554, -55.83218693733216],
            [-34.76716450734977, -55.83052396774293],
            [-34.766865051823196, -55.828850269317634],
            [-34.76480406373039, -55.82936525344849],
          ],
        },
        {
          id: "65",
          coords: [
            [-34.766865051823196, -55.828839540481574],
            [-34.76624852231816, -55.82520246505738],
            [-34.76544702707698, -55.825545787811286],
            [-34.76464552405329, -55.82616806030274],
            [-34.76432844378566, -55.82652211189271],
            [-34.764795255978534, -55.82936525344849],
          ],
        },
        {
          id: "66",
          coords: [
            [-34.76431963598306, -55.82648992538453],
            [-34.76400255446363, -55.82447290420533],
            [-34.76463671628452, -55.82476258277894],
            [-34.76535895020228, -55.824816226959236],
            [-34.766178061510075, -55.82474112510681],
            [-34.766239714720435, -55.8251702785492],
            [-34.76558794988108, -55.82545995712281],
            [-34.76539418096345, -55.825545787811286],
            [-34.76494498763216, -55.825856924057014],
          ],
        },
        {
          id: "67",
          coords: [
            [-34.766178061510075, -55.82470893859864],
            [-34.76586098712937, -55.82292795181275],
            [-34.76383520539286, -55.82347512245179],
            [-34.76400255446363, -55.82449436187745],
            [-34.76455744632334, -55.82476258277894],
            [-34.76531491172966, -55.824816226959236],
          ],
        },
        {
          id: "68",
          coords: [
            [-34.76384401324716, -55.82346439361573],
            [-34.7636854717262, -55.822606086730964],
            [-34.76431082817951, -55.82189798355103],
            [-34.76495379536805, -55.82145810127259],
            [-34.76561437288007, -55.821318626403816],
            [-34.765843371850266, -55.82291722297669],
          ],
        },
        {
          id: "76",
          coords: [
            [-34.76366785598287, -55.822563171386726],
            [-34.76347408255795, -55.82153320312501],
            [-34.763139381934494, -55.82121133804322],
            [-34.76298964700571, -55.820825099945075],
            [-34.76298964700571, -55.820353031158454],
            [-34.76312176607463, -55.819827318191535],
            [-34.76452221520504, -55.81937670707703],
            [-34.76488333345474, -55.82145810127259],
            [-34.76430202037503, -55.82188725471497],
          ],
        },
        {
          id: "78",
          coords: [
            [-34.762822295881556, -55.81804633140565],
            [-34.762522824602094, -55.81642627716065],
            [-34.76268136835596, -55.81626534461976],
            [-34.763852821100514, -55.816104412078865],
            [-34.76409063278563, -55.815353393554695],
            [-34.76608998541541, -55.81653356552124],
            [-34.76615163869155, -55.81728458404542],
            [-34.765772910696334, -55.817123651504524],
          ],
        },
        {
          id: "77",
          coords: [
            [-34.76312176607463, -55.819805860519416],
            [-34.76283110384392, -55.81800341606141],
            [-34.76539418096345, -55.8172631263733],
            [-34.76517398845944, -55.81912994384766],
          ],
        },
        {
          id: "75",
          coords: [
            [-34.76491856441891, -55.82144737243653],
            [-34.76622209952218, -55.821114778518684],
            [-34.766371828587594, -55.820342302322395],
            [-34.76645990438152, -55.819805860519416],
            [-34.76629256029267, -55.81889390945435],
            [-34.76626613751079, -55.81855058670045],
            [-34.7666360556875, -55.81764936447144],
            [-34.76579052599047, -55.817123651504524],
            [-34.76540298865136, -55.81724166870118],
            [-34.76517398845944, -55.819097757339485],
            [-34.764495791856454, -55.81937670707703],
          ],
        },
        {
          id: "80",
          coords: [
            [-34.76534133481603, -55.811576843261726],
            [-34.767094047323624, -55.81045031547547],
            [-34.767525614039755, -55.81448435783387],
            [-34.76676816892024, -55.81499934196473],
            [-34.766001909226716, -55.81583619117737],
          ],
        },
        {
          id: "79",
          coords: [
            [-34.76615163869155, -55.817338228225715],
            [-34.76601071684983, -55.81582546234131],
            [-34.76681220661751, -55.81496715545654],
            [-34.767499191652604, -55.81451654434205],
            [-34.76787791172699, -55.81757426261902],
            [-34.76762249605366, -55.81817507743836],
          ],
        },
        {
          id: "74",
          coords: [
            [-34.7666448632429, -55.81762790679932],
            [-34.76877626402308, -55.818872451782234],
            [-34.76832708909728, -55.81997752189637],
            [-34.76837112596281, -55.82151174545289],
            [-34.76819497835978, -55.822252035141],
            [-34.76621329192164, -55.821093320846565],
            [-34.76645109680637, -55.81983804702759],
            [-34.76626613751079, -55.818818807601936],
            [-34.76627494510568, -55.81851840019227],
          ],
        },
        {
          id: "69",
          coords: [
            [-34.76622209952218, -55.821082592010505],
            [-34.768186170969756, -55.82227349281312],
            [-34.767287812250814, -55.8246660232544],
            [-34.76719973734029, -55.82551360130311],
            [-34.76624852231816, -55.8252239227295],
            [-34.765605565214685, -55.821307897567756],
          ],
        },
        {
          id: "63",
          coords: [
            [-34.76716450734977, -55.83048105239868],
            [-34.76625732991495, -55.82523465156556],
            [-34.768837915292686, -55.8259642124176],
            [-34.76874984203631, -55.826565027236946],
            [-34.76876745669509, -55.82714438438416],
            [-34.768873144568936, -55.82769155502319],
            [-34.76905809802252, -55.828195810318],
            [-34.76927828016494, -55.82857131958008],
          ],
        },
        {
          id: "70",
          coords: [
            [-34.768846722613176, -55.82593202590943],
            [-34.76985955819855, -55.8232605457306],
            [-34.76819497835978, -55.82227349281312],
            [-34.767296619736676, -55.82465529441834],
            [-34.76720854483558, -55.82550287246705],
          ],
        },
        {
          id: "72",
          coords: [
            [-34.76819497835978, -55.82227349281312],
            [-34.768388740702456, -55.82139372825623],
            [-34.76836231859158, -55.82097530364991],
            [-34.77008854539076, -55.82211256027222],
            [-34.770308724784094, -55.82189798355103],
            [-34.77083715293147, -55.82166194915772],
            [-34.771383191795806, -55.82150101661683],
            [-34.77170024496231, -55.82348585128785],
            [-34.770872381354316, -55.82373261451722],
            [-34.770687431966564, -55.82372188568116],
            [-34.769833136558574, -55.82324981689454],
          ],
        },
        {
          id: "71",
          coords: [
            [-34.769841943772846, -55.82328200340272],
            [-34.76911094179028, -55.82525610923767],
            [-34.77050248216434, -55.826082229614265],
            [-34.77125989301319, -55.825824737548835],
            [-34.771612174760456, -55.826554298400886],
            [-34.77223747115825, -55.82639336585999],
            [-34.77167382391163, -55.82348585128785],
            [-34.77088999556009, -55.82374334335328],
            [-34.770705046211816, -55.82374334335328],
          ],
        },
        {
          id: "62",
          coords: [
            [-34.77159721119306, -55.826565027236946],
            [-34.771244929381886, -55.825824737548835],
            [-34.77047871125033, -55.826082229614265],
            [-34.76910478506229, -55.82526683807373],
            [-34.76884056586547, -55.8259642124176],
            [-34.76877010727013, -55.82653284072877],
            [-34.76877010727013, -55.82720875740052],
            [-34.76889340977252, -55.827820301055915],
            [-34.76926331617438, -55.828592777252204],
            [-34.769844594313376, -55.82901120185853],
            [-34.77080457500324, -55.82748770713807],
            [-34.77099833121934, -55.827573537826545],
            [-34.7715884041661, -55.827326774597175],
          ],
        },
        {
          id: "61",
          coords: [
            [-34.769853401526404, -55.829043388366706],
            [-34.77080457500324, -55.82747697830201],
            [-34.770989524128474, -55.827573537826545],
            [-34.7715884041661, -55.827316045761116],
            [-34.771623632268266, -55.82661867141724],
            [-34.77223131466349, -55.82641482353211],
            [-34.772733309788805, -55.829043388366706],
            [-34.77108640207629, -55.82945108413696],
            [-34.77033779679651, -55.829333066940315],
          ],
        },
        {
          id: "81",
          coords: [
            [-34.76751064973139, -55.81447362899781],
            [-34.76950111227152, -55.81393718719483],
            [-34.76958918472622, -55.81449508666993],
            [-34.768373776550575, -55.81753134727479],
            [-34.76787175490703, -55.81762790679932],
          ],
        },
        {
          id: "82",
          coords: [
            [-34.76951872676999, -55.813915729522705],
            [-34.77001193120051, -55.81379771232606],
            [-34.770276146647305, -55.81518173217774],
            [-34.768778914597846, -55.818872451782234],
            [-34.76764276156429, -55.81818580627442],
            [-34.76789817717491, -55.817595720291145],
            [-34.76840900602494, -55.81754207611085],
            [-34.769615606444304, -55.81439852714539],
          ],
        },
        {
          id: "83",
          coords: [
            [-34.768778914597846, -55.818872451782234],
            [-34.77025853231049, -55.81517100334168],
            [-34.77101594539827, -55.81954836845399],
            [-34.77017926774835, -55.81974148750306],
          ],
        },
        {
          id: "73",
          coords: [
            [-34.77138584228681, -55.82149028778077],
            [-34.7710335595734, -55.81954836845399],
            [-34.77017046057011, -55.81976294517518],
            [-34.76876129994148, -55.81888318061829],
            [-34.768329739686465, -55.82000970840454],
            [-34.76835616180773, -55.82098603248597],
            [-34.77008238873569, -55.822091102600105],
            [-34.77033779679651, -55.821844339370735],
            [-34.77070769672463, -55.82168340682984],
          ],
        },
        {
          id: "25",
          coords: [
            [-34.77381139478587, -55.83251416683198],
            [-34.77357801451612, -55.831038951873786],
            [-34.77732079612789, -55.83003044128419],
            [-34.77753214983208, -55.831317901611335],
            [-34.77682763537936, -55.83118915557861],
            [-34.77608788872969, -55.831339359283454],
            [-34.775436201662494, -55.831875801086426],
            [-34.77548916698398, -55.832101106643684],
          ],
        },
        {
          id: "26",
          coords: [
            [-34.77779984101295, -55.8326268196106],
            [-34.777306683127755, -55.83000898361207],
            [-34.77940258378223, -55.82945108413696],
            [-34.77982527998327, -55.832101106643684],
          ],
        },
        {
          id: "27",
          coords: [
            [-34.77982527998327, -55.832079648971565],
            [-34.77940258378223, -55.829429626464844],
            [-34.78097887734446, -55.82898974418641],
            [-34.78165693849497, -55.83162903785706],
          ],
        },
        {
          id: "24",
          coords: [
            [-34.77355568038217, -55.831038951873786],
            [-34.773150565784164, -55.828914642333984],
            [-34.77565167631965, -55.828292369842536],
            [-34.77602155242893, -55.830352306365974],
          ],
        },
        {
          id: "21",
          coords: [
            [-34.77602155242893, -55.830352306365974],
            [-34.775193732172895, -55.82593202590943],
            [-34.775369864837806, -55.825545787811286],
            [-34.776567556988454, -55.82503080368043],
            [-34.77728968650164, -55.827047824859626],
            [-34.77720162226527, -55.828356742858894],
            [-34.77751865307639, -55.82996606826782],
          ],
        },
        {
          id: "20",
          coords: [
            [-34.773150565784164, -55.82887172698975],
            [-34.77271022157409, -55.826361179351814],
            [-34.77501759913198, -55.82576036453248],
            [-34.775190603182274, -55.82594275474548],
            [-34.77562212755987, -55.828308463096626],
          ],
        },
        {
          id: "22",
          coords: [
            [-34.776551523420785, -55.82503080368043],
            [-34.77935194217205, -55.82346439361573],
            [-34.77996837378656, -55.825417041778564],
            [-34.77732649158129, -55.82696199417115],
          ],
        },
        {
          id: "23",
          coords: [
            [-34.78093704273201, -55.82897901535035],
            [-34.77996837378656, -55.825331211090095],
            [-34.77727365307429, -55.82700490951538],
            [-34.77722081453348, -55.82827091217042],
            [-34.7775202324841, -55.82998752593995],
          ],
        },
        {
          id: "17",
          coords: [
            [-34.77934276505949, -55.82345366477967],
            [-34.7786294597921, -55.82143664360047],
            [-34.77788092294182, -55.82189798355103],
            [-34.777616731843814, -55.821855068206794],
            [-34.77743179757185, -55.82179069519044],
            [-34.77690341165361, -55.82210183143616],
            [-34.77770479563715, -55.824376344680786],
          ],
        },
        {
          id: "16",
          coords: [
            [-34.77690341165361, -55.822091102600105],
            [-34.77641905492269, -55.82052469253541],
            [-34.77625173102757, -55.819677114486694],
            [-34.77788972929715, -55.81888318061829],
            [-34.77864707234212, -55.821404457092285],
            [-34.778127500536705, -55.8217477798462],
            [-34.77787211658551, -55.82188725471497],
            [-34.777440603975165, -55.82175850868225],
          ],
        },
        {
          id: "15",
          coords: [
            [-34.777678376508995, -55.824365615844734],
            [-34.77688579873142, -55.822069644927986],
            [-34.77641905492269, -55.820610523223884],
            [-34.77623411796626, -55.819730758667],
            [-34.77482506087842, -55.820310115814216],
            [-34.77655995899223, -55.82504153251649],
          ],
        },
        {
          id: "18",
          coords: [
            [-34.77652473299741, -55.825052261352546],
            [-34.77536226673129, -55.825545787811286],
            [-34.775115680872396, -55.825427770614624],
            [-34.77428785152814, -55.82282066345215],
            [-34.77548555938436, -55.82218766212464],
          ],
        },
        {
          id: "19",
          coords: [
            [-34.772711430130684, -55.826350450515754],
            [-34.77218301398466, -55.82333564758301],
            [-34.77428785152814, -55.822842121124275],
            [-34.775098067568585, -55.82545995712281],
            [-34.77498358100204, -55.82576036453248],
          ],
        },
        {
          id: "14",
          coords: [
            [-34.77217420702022, -55.82333564758301],
            [-34.77184834867543, -55.82146883010865],
            [-34.77364495705284, -55.82092165946961],
            [-34.77481625419598, -55.820310115814216],
            [-34.7754679461595, -55.8221983909607],
            [-34.77426143130594, -55.822852849960334],
          ],
        },
        {
          id: "13",
          coords: [
            [-34.77183954167526, -55.82145810127259],
            [-34.77149606793631, -55.81946253776551],
            [-34.77321342233534, -55.81895828247071],
            [-34.774340691947216, -55.8192265033722],
            [-34.77514210082112, -55.82017064094544],
            [-34.77397080830329, -55.82074999809266],
            [-34.77327507029031, -55.82103967666627],
          ],
        },
        {
          id: "11",
          coords: [
            [-34.77574975730636, -55.81992387771607],
            [-34.7744463726838, -55.816072225570686],
            [-34.77345120705066, -55.816608667373664],
            [-34.77441114578664, -55.81930160522462],
            [-34.77515090746879, -55.8201813697815],
          ],
        },
        {
          id: "12",
          coords: [
            [-34.774367112144034, -55.81924796104432],
            [-34.77301086444483, -55.815567970275886],
            [-34.77168982252891, -55.81641554832459],
            [-34.77096764400806, -55.8166515827179],
            [-34.77149606793631, -55.81947326660157],
            [-34.773222229188875, -55.81892609596253],
          ],
        },
        {
          id: "8",
          coords: [
            [-34.77095883691391, -55.816619396209724],
            [-34.770113351500676, -55.81199526786804],
            [-34.77087076592086, -55.81173777580262],
            [-34.772244662709376, -55.81602931022645],
            [-34.771681015511845, -55.81642627716065],
          ],
        },
        {
          id: "9",
          coords: [
            [-34.772253469666296, -55.81605076789857],
            [-34.77118782105603, -55.81273555755616],
            [-34.77209494429801, -55.81214547157288],
            [-34.77394438797955, -55.813615322113044],
            [-34.77353927528987, -55.81416249275208],
            [-34.77353046847018, -55.81503152847291],
            [-34.77308131941967, -55.81551432609559],
          ],
        },
        {
          id: "10",
          coords: [
            [-34.773962001529654, -55.813615322113044],
            [-34.77208613732417, -55.81213474273682],
            [-34.77560004525443, -55.811609029769905],
            [-34.77583782309238, -55.812606811523445],
            [-34.77413813682376, -55.813368558883674],
          ],
        },
        {
          id: "7",
          coords: [
            [-34.7701045443154, -55.81199526786804],
            [-34.770853151710945, -55.81173777580262],
            [-34.77165459445501, -55.809870958328254],
            [-34.77264978175467, -55.80892682075501],
            [-34.77125827758732, -55.80711364746094],
            [-34.77028949500939, -55.80825090408326],
            [-34.77032472366605, -55.80876588821412],
            [-34.77004289399193, -55.80918431282044],
            [-34.76967299108412, -55.809592008590705],
          ],
        },
        {
          id: "6",
          coords: [
            [-34.769664183851845, -55.809570550918586],
            [-34.770307109339605, -55.808819532394416],
            [-34.77025426633772, -55.80822944641114],
            [-34.771267084649516, -55.807092189788825],
            [-34.77046563814219, -55.8060622215271],
            [-34.76994601481918, -55.80664157867432],
            [-34.76937354465877, -55.80596566200257],
            [-34.769030060656476, -55.80587983131409],
          ],
        },
        {
          id: "5",
          coords: [
            [-34.77266739558108, -55.80889463424683],
            [-34.773231036041466, -55.8082401752472],
            [-34.771372769322376, -55.80580472946168],
            [-34.77075627348936, -55.80553650856018],
            [-34.76876584122043, -55.80446362495423],
            [-34.769021253355554, -55.80587983131409],
            [-34.76939996644588, -55.80595493316651],
            [-34.76994601481918, -55.80665230751038],
            [-34.77047444528894, -55.80605149269104],
          ],
        },
        {
          id: "4",
          coords: [
            [-34.773222229188875, -55.80820798873902],
            [-34.773997228618555, -55.8072316646576],
            [-34.773486434357615, -55.80540776252747],
            [-34.77319580862549, -55.80543994903565],
            [-34.77303728506744, -55.80523610115052],
            [-34.7730284781942, -55.80496788024903],
            [-34.772808306057115, -55.8048176765442],
            [-34.77205090941945, -55.805107355117805],
            [-34.77223585575151, -55.805826187133796],
            [-34.771821927672164, -55.806384086608894],
          ],
        },
        {
          id: "3",
          coords: [
            [-34.771821927672164, -55.806373357772834],
            [-34.77220943487231, -55.80581545829774],
            [-34.772033295461455, -55.805107355117805],
            [-34.772579326411396, -55.804882049560554],
            [-34.77234153918373, -55.80413103103638],
            [-34.77155771717423, -55.80372333526612],
            [-34.77123185639514, -55.80454945564271],
            [-34.768536850358316, -55.80324053764344],
            [-34.7687746485486, -55.80446362495423],
            [-34.770914801429115, -55.805600881576545],
            [-34.77135515521962, -55.80576181411744],
          ],
        },
        {
          id: "2",
          coords: [
            [-34.7705184810087, -55.79901337623597],
            [-34.76777941451891, -55.79900264739991],
            [-34.76852804300479, -55.8032512664795],
            [-34.76997243642303, -55.80392718315125],
            [-34.77020142330204, -55.803326368331916],
            [-34.77053609529003, -55.80301523208619],
            [-34.770826730389075, -55.802382230758674],
            [-34.770712237896475, -55.80154538154603],
            [-34.770580130976896, -55.80092310905457],
          ],
        },
        {
          id: "1",
          coords: [
            [-34.767797029384845, -55.79901337623597],
            [-34.767206929330406, -55.795848369598396],
            [-34.7714168045628, -55.79592347145081],
            [-34.7705184810087, -55.79901337623597],
          ],
        },
      ];

      /*************** UTILIDADES ***************/
      function diferenciaEnMeses(a, b) {
        return (
          (b.getFullYear() - a.getFullYear()) * 12 +
          (b.getMonth() - a.getMonth())
        );
      }
      function quitarTildes(s) {
        return s.normalize?.("NFD").replace(/\p{Diacritic}/gu, "") || s;
      }
      function parseCSVLine(line) {
        const out = [];
        let cur = "",
          inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQ = !inQ;
            }
          } else if (ch === "," && !inQ) {
            out.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        return out;
      }
      function parseFechaSeguro(s) {
        s = String(s || "").trim();
        if (!s) return new Date("Invalid");
        const d1 = new Date(s);
        if (!isNaN(d1)) return d1;
        const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
        if (m) return new Date(+m[3], +m[2] - 1, +m[1]);
        return new Date("Invalid");
      }
      function normalizarFinalizado(v) {
        const s = String(v ?? "")
          .trim()
          .toLowerCase();
        if (!s) return "";
        if (
          [
            "si",
            "sí",
            "s",
            "true",
            "1",
            "ok",
            "finalizado",
            "completo",
            "terminado",
          ].includes(s)
        )
          return "Si";
        if (["no", "n", "false", "0", "pendiente", "incompleto"].includes(s))
          return "No";
        return s;
      }
      function obtenerColor(fecha, finalizado) {
        if (!(fecha instanceof Date) || isNaN(fecha)) return "red";
        const ahora = new Date();
        const diffMeses = diferenciaEnMeses(fecha, ahora);
        const fin = String(finalizado ?? "")
          .trim()
          .toLowerCase();
        const esSi =
          [
            "si",
            "sí",
            "true",
            "1",
            "ok",
            "finalizado",
            "completo",
            "terminado",
          ].includes(fin) || finalizado === true;
        if (diffMeses < 2 && !esSi) return "blue";
        if (diffMeses < 2 && esSi) return "green";
        if (diffMeses <= 3) return "yellow";
        return "red";
      }
      function actualizarContadores() {
        document.getElementById("contador-azul").textContent = contadores.blue;
        document.getElementById("contador-verde").textContent =
          contadores.green;
        document.getElementById("contador-amarillo").textContent =
          contadores.yellow;
        document.getElementById("contador-rojo").textContent = contadores.red;
      }

      /*************** FETCH CSV ROBUSTO (con fallbacks CORS) ***************/
      async function fetchTextWithFallback(sheetCsvUrl) {
        // Intento directo (sirve si usás Live Server/localhost y Google permite CORS)
        try {
          const res = await fetch(sheetCsvUrl, {
            redirect: "follow",
            headers: { Accept: "text/csv" },
          });
          if (res.ok) {
            const txt = await res.text();
            if (txt && txt.trim() !== "") return txt;
          }
        } catch (_) {}

        // Proxies públicos (ordenados por confiabilidad percibida)
        const candidates = [
          // AllOrigins
          "https://api.allorigins.win/raw?url=" +
            encodeURIComponent(sheetCsvUrl),
          // cors.isomorphic-git.org
          "https://cors.isomorphic-git.org/" + sheetCsvUrl,
          // r.jina.ai (http/https)
          "https://r.jina.ai/http://" + sheetCsvUrl.replace(/^https?:\/\//, ""),
          "https://r.jina.ai/https://" +
            sheetCsvUrl.replace(/^https?:\/\//, ""),
        ];

        for (const url of candidates) {
          try {
            const res = await fetch(url, { redirect: "follow" });
            if (res.ok) {
              const txt = await res.text();
              if (txt && txt.trim() !== "") return txt;
            }
          } catch (e) {
            console.warn("Proxy falló:", url, e);
          }
        }

        throw new Error(
          "No se pudo obtener el CSV (CORS/proxy). Sugerencia: serví el HTML en http://localhost y/o crea un WebApp en Apps Script como proxy."
        );
      }

      function indicesPorEncabezado(headers) {
        const norm = headers.map((h) =>
          quitarTildes(
            String(h || "")
              .trim()
              .toLowerCase()
          )
        );
        const lookup = (...aliases) => {
          const aliNorm = aliases.map((a) => quitarTildes(a.toLowerCase()));
          for (let i = 0; i < norm.length; i++)
            if (aliNorm.includes(norm[i])) return i;
          return -1;
        };
        return {
          id: lookup("id", "identificador", "territorio"),
          fecha: lookup(
            "ultima fecha",
            "última fecha",
            "fecha",
            "fecha ultima",
            "fecha última"
          ),
          finalizado: lookup(
            "finalizado",
            "se finalizo el territorio",
            "se finalizó el territorio",
            "¿se finalizó?",
            "se finalizo",
            "se finalizó",
            "estado"
          ),
        };
      }

      async function cargarDatosDesdeSheets() {
        try {
          const csvData = await fetchTextWithFallback(SHEET_CSV); // 🔧 usa fallbacks CORS
          const filas = csvData.split(/\r?\n/).filter((l) => l.trim() !== "");
          if (filas.length === 0) return [];
          const headerCols = parseCSVLine(filas[0]);
          let start = 0;
          let idxId = 0,
            idxFecha = 1,
            idxFin = 2;

          const joined = headerCols.join(",").toLowerCase();
          const looksHeader = /id|fecha|finaliz/.test(joined);
          if (looksHeader) {
            const { id, fecha, finalizado } = indicesPorEncabezado(headerCols);
            if (id !== -1) idxId = id;
            if (fecha !== -1) idxFecha = fecha;
            if (finalizado !== -1) idxFin = finalizado;
            start = 1;
          }

          const datos = [];
          for (let i = start; i < filas.length; i++) {
            const cols = parseCSVLine(filas[i]);
            const idStr = (cols[idxId] ?? "").trim();
            const fechaStr = (cols[idxFecha] ?? "").trim();
            const finStr = (cols[idxFin] ?? "").trim();

            // 🔧 Guardamos id también como string para comparar con poligonos
            const idNum = parseInt(idStr, 10);
            const id = Number.isInteger(idNum) ? idNum : idStr; // conserva no numéricos
            const fecha = parseFechaSeguro(fechaStr);
            const finalizado = normalizarFinalizado(finStr);

            if (idStr !== "" && fecha instanceof Date && !isNaN(fecha)) {
              datos.push({ id, fecha, finalizado });
            }
          }
          return datos;
        } catch (error) {
          console.error("Error cargando datos desde Google Sheets:", error);
          return [];
        }
      }

      /*************** UI: panel info ***************/
      const infoPanel = document.getElementById("info-panel");
      const polygonId = document.getElementById("polygon-id");
      const polygonFecha = document.getElementById("polygon-fecha");

      /*************** CARGA DEL MAPA ***************/
      async function cargarMapa() {
        const datosSheets = await cargarDatosDesdeSheets();

        contadores = { blue: 0, green: 0, yellow: 0, red: 0 };

        poligonos.forEach((p) => {
          // 🔧 match por string para evitar "32" vs 32
          const dato = datosSheets.find((d) => String(d.id) === String(p.id));
          p.fecha = dato ? dato.fecha : null;
          p.finalizado = dato ? dato.finalizado : "";

          const colorInicial = obtenerColor(p.fecha, p.finalizado);
          if (contadores[colorInicial] != null) contadores[colorInicial]++;

          const poly = L.polygon(p.coords, {
            color: "black",
            fillColor: colorInicial,
            fillOpacity: 0.5,
          }).addTo(map);

          const tooltipContent = `
          <div class="tooltip-content">
            <div><strong>${p.id}</strong></div>
          </div>
        `;
          poly.bindTooltip(tooltipContent, {
            permanent: true,
            direction: "center",
            className: "label",
          });

          poly.on("click", function () {
            infoPanel.style.display = "block";
            polygonId.textContent = p.id;
            polygonFecha.textContent =
              p.fecha instanceof Date && !isNaN(p.fecha)
                ? p.fecha.toLocaleDateString()
                : "Fecha no disponible";
          });
        });

        actualizarContadores();
      }

      /*************** RANKING (SIN HACER, MÁS ANTIGUOS) ***************/
      async function mostrarRanking() {
        try {
          const datosSheets = await cargarDatosDesdeSheets();
          if (!Array.isArray(datosSheets) || datosSheets.length === 0) {
            document.getElementById("ranking-container").innerHTML =
              "<h3>Territorios sin hacer</h3><p>No se pudieron cargar datos.</p>";
            return;
          }

          // Finalizado != 'Si'
          const sinHacer = datosSheets.filter(
            (d) => String(d.finalizado).toLowerCase() !== "si"
          );

          // Ordenar por fecha (más antigua primero)
          sinHacer.sort((a, b) => a.fecha - b.fecha);

          const lista = sinHacer.slice(0, N_RANK);

          let html = "<h3>Territorios sin hacer</h3><ul>";
          const hoy = new Date();
          for (const d of lista) {
            const fechaTxt =
              d.fecha instanceof Date && !isNaN(d.fecha)
                ? d.fecha.toLocaleDateString()
                : "-";
            const meses =
              d.fecha instanceof Date && !isNaN(d.fecha)
                ? diferenciaEnMeses(d.fecha, hoy)
                : "?";
            html += `<li>${d.id} - ${fechaTxt} (${meses} mes${
              meses === 1 ? "" : "es"
            })</li>`;
          }
          html += "</ul>";

          document.getElementById("ranking-container").innerHTML = html;
        } catch (e) {
          console.error(e);
          document.getElementById("ranking-container").innerHTML =
            "<h3>Territorios sin hacer</h3><p>Error al cargar datos.</p>";
        }
      }

      /*************** INIT ***************/
      mostrarRanking();
      cargarMapa();

      // (Opcional) refrescar cada 5 minutos:
      // setInterval(() => { mostrarRanking(); /* y si querés: recargar mapa */ }, 5 * 60 * 1000);

         document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById("toggle-referencias");
        const paneles = [
          document.getElementById("referencias"),
          document.getElementById("ranking-container"),
          document.getElementById("contador-poligonos"),
          document.getElementById("info-panel"),
        ];

        let visible = false;

        btn.addEventListener("click", function () {
          // Animación de escala
          btn.classList.add("animate");
          setTimeout(() => btn.classList.remove("animate"), 200); // Dura lo mismo que el @keyframes

          // Mostrar u ocultar paneles
          visible = !visible;
          paneles.forEach((panel) => {
            if (panel) {
              panel.style.display = visible ? "block" : "none";
            }
          });

          // Cambiar texto del botón
          btn.textContent = visible
            ? "❌ Ocultar Información"
            : "📋 Ver Información";
        });
      });
    </script>
  </body>
</html>
