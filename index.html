<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Territorios Marindia</title>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- (Opcional) Leaflet.Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    #map { height: 900px; width: 100%; }
    #info-panel {
      position: fixed; width: 10%; top: 50%; left: 50px; height: 10%;
      overflow-y: auto; background: rgba(0,0,0,.8); color: #fff;
      padding: 15px; border-radius: 10px; font-family: Arial, sans-serif;
      box-shadow: 2px 2px 10px rgba(0,0,0,.5); z-index: 1000;
    }
    .label { font-size: 14px; font-weight: bold; background: #fff; padding: 2px; border-radius: 5px; }
    .tooltip-content { display: flex; flex-direction: column; align-items: center; }
    .hidden { display: none; }

    #referencias, #ranking-container, #contador-poligonos {
      position: fixed; background: rgba(0,0,0,.8); color:#fff; padding: 15px;
      border-radius: 10px; font-family: Arial, sans-serif;
      box-shadow: 2px 2px 10px rgba(0,0,0,.5); z-index: 1000;
    }
    #referencias { top: 10px; left: 50px; width: 250px; max-height: 400px; overflow-y: auto; }
    #ranking-container { top: 10px; right: 10px; width: 250px; max-height: 400px; overflow-y: auto; }
    #contador-poligonos { bottom: 10px; right: 10px; width: 250px; max-height: 400px; overflow-y: auto; }

    .referencias { display: flex; flex-direction: column; gap: 10px; margin-top: 0; }
    .referencia { display: flex; align-items: center; gap: 10px; }
    .color-box { width: 20px; height: 20px; border: 1px solid #000; }
    .azul { background: rgb(9,0,128); }
    .verde { background: green; }
    .amarillo { background: yellow; }
    .rojo { background: red; }
    .gris { background: gray; }

    #ranking-container h3 {
      font-size: 16px; margin-bottom: 10px; text-align: center;
      border-bottom: 1px solid #fff; padding-bottom: 5px;
    }
    #ranking-container ul { list-style: none; padding: 0; margin: 0; }
    #ranking-container li { font-size: 14px; margin: 5px 0; }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="info-panel">
    <p><strong>Territorio:</strong> <span id="polygon-id"></span></p>
    <p><strong>√öltima visita:</strong> <span id="polygon-fecha"></span></p>
  </div>

  <div id="referencias">
    <h3 style="margin-top:0">Referencias</h3>
    <div class="referencias">
      <div class="referencia"><div class="color-box azul"></div><span>Se est√° trabajando</span></div>
      <div class="referencia"><div class="color-box verde"></div><span>Menos de 2 meses (finalizado)</span></div>
      <div class="referencia"><div class="color-box amarillo"></div><span>M√°s de 2 y menos de 3 meses</span></div>
      <div class="referencia"><div class="color-box rojo"></div><span>3 meses o m√°s</span></div>
    </div>
  </div>

  <div id="contador-poligonos">
    <h3>Estado de territorios</h3>
    <p>Trabajando: <span id="contador-azul">0</span></p>
    <p>Realizados: <span id="contador-verde">0</span></p>
    <p>Realizar: <span id="contador-amarillo">0</span></p>
    <p>Urgentes: <span id="contador-rojo">0</span></p>
  </div>

  <div id="ranking-container"></div>

  <script>
    /*************** CONFIG ***************/
    const SHEET_CSV =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQDOYlDoIJ04iSCXs-p5M3n8iATEX1Jlgn6i1WuwcUhe7JBCbPiE82k1HpyaMl1L8Ys-7HIfAcz3L_U/pub?gid=1159469350&single=true&output=csv';

    const N_RANK = 20;
    let contadores = { blue: 0, green: 0, yellow: 0, red: 0 };

    /*************** MAPA ***************/
    const map = L.map('map').setView([-34.771180, -55.826602], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    /*************** POL√çGONOS (tu dataset) ***************/
    var poligonos = [
  {
    "id": "1",
    "territorio": "1",
    "coords": [
      [
        -34.767192,
        -55.795883
      ],
      [
        -34.771371,
        -55.79584
      ],
      [
        -34.771865,
        -55.797835
      ],
      [
        -34.770719,
        -55.798972
      ],
      [
        -34.767792,
        -55.799058
      ]
    ]
  },
  {
    "id": "2",
    "territorio": "2",
    "coords": [
      [
        -34.770684,
        -55.799015
      ],
      [
        -34.770604,
        -55.804238
      ],
      [
        -34.768639,
        -55.803262
      ],
      [
        -34.767792,
        -55.799122
      ]
    ]
  },
  {
    "id": "3",
    "territorio": "3",
    "coords": [
      [
        -34.768648,
        -55.803286
      ],
      [
        -34.771205,
        -55.804584
      ],
      [
        -34.771567,
        -55.803629
      ],
      [
        -34.772378,
        -55.804069
      ],
      [
        -34.772598,
        -55.804863
      ],
      [
        -34.772863,
        -55.804755
      ],
      [
        -34.773118,
        -55.805034
      ],
      [
        -34.773215,
        -55.805388
      ],
      [
        -34.773542,
        -55.805334
      ],
      [
        -34.774035,
        -55.807448
      ],
      [
        -34.772669,
        -55.809089
      ],
      [
        -34.770412,
        -55.806096
      ],
      [
        -34.769856,
        -55.806579
      ],
      [
        -34.769336,
        -55.805903
      ],
      [
        -34.769054,
        -55.805817
      ]
    ]
  },
  {
    "id": "4",
    "territorio": "4",
    "coords": [
      [
        -34.769063,
        -55.80586
      ],
      [
        -34.77013,
        -55.811985
      ],
      [
        -34.770888,
        -55.811749
      ],
      [
        -34.771673,
        -55.80985
      ],
      [
        -34.772642,
        -55.809089
      ],
      [
        -34.770394,
        -55.806118
      ],
      [
        -34.769847,
        -55.806611
      ],
      [
        -34.769318,
        -55.805914
      ]
    ]
  },
  {
    "id": "5",
    "territorio": "5",
    "coords": [
      [
        -34.770138,
        -55.811985
      ],
      [
        -34.770932,
        -55.811727
      ],
      [
        -34.771364,
        -55.813025
      ],
      [
        -34.772078,
        -55.8128
      ],
      [
        -34.773048,
        -55.8156
      ],
      [
        -34.771699,
        -55.816479
      ],
      [
        -34.77095,
        -55.816662
      ],
      [
        -34.770438,
        -55.81369
      ]
    ]
  },
  {
    "id": "6",
    "territorio": "6",
    "coords": [
      [
        -34.773609,
        -55.814248
      ],
      [
        -34.773547,
        -55.814999
      ],
      [
        -34.773036,
        -55.815589
      ],
      [
        -34.772052,
        -55.812832
      ],
      [
        -34.772052,
        -55.812146
      ],
      [
        -34.775605,
        -55.811545
      ],
      [
        -34.77594,
        -55.812907
      ],
      [
        -34.774141,
        -55.813862
      ]
    ]
  },
  {
    "id": "7",
    "territorio": "7",
    "coords": [
      [
        -34.770941,
        -55.816672
      ],
      [
        -34.771734,
        -55.81649
      ],
      [
        -34.773092,
        -55.815632
      ],
      [
        -34.773462,
        -55.816619
      ],
      [
        -34.774459,
        -55.81604
      ],
      [
        -34.775755,
        -55.819944
      ],
      [
        -34.775146,
        -55.820126
      ],
      [
        -34.77437,
        -55.819215
      ],
      [
        -34.773647,
        -55.818979
      ],
      [
        -34.772995,
        -55.819054
      ],
      [
        -34.771505,
        -55.819461
      ]
    ]
  },
  {
    "id": "8",
    "territorio": "8",
    "coords": [
      [
        -34.771514,
        -55.819483
      ],
      [
        -34.773215,
        -55.819054
      ],
      [
        -34.773647,
        -55.818979
      ],
      [
        -34.774353,
        -55.819204
      ],
      [
        -34.774661,
        -55.819654
      ],
      [
        -34.775508,
        -55.822143
      ],
      [
        -34.774282,
        -55.822776
      ],
      [
        -34.772166,
        -55.823419
      ]
    ]
  },
  {
    "id": "9",
    "territorio": "9",
    "coords": [
      [
        -34.774952,
        -55.820298
      ],
      [
        -34.775137,
        -55.820137
      ],
      [
        -34.776222,
        -55.819772
      ],
      [
        -34.777773,
        -55.818957
      ],
      [
        -34.778443,
        -55.818796
      ],
      [
        -34.778593,
        -55.819333
      ],
      [
        -34.778294,
        -55.820008
      ],
      [
        -34.779351,
        -55.823377
      ],
      [
        -34.776557,
        -55.824889
      ]
    ]
  },
  {
    "id": "10",
    "territorio": "10",
    "coords": [
      [
        -34.775508,
        -55.822164
      ],
      [
        -34.776469,
        -55.824953
      ],
      [
        -34.775393,
        -55.825543
      ],
      [
        -34.775164,
        -55.825468
      ],
      [
        -34.775005,
        -55.825651
      ],
      [
        -34.774846,
        -55.82579
      ],
      [
        -34.772686,
        -55.826337
      ],
      [
        -34.772184,
        -55.82343
      ],
      [
        -34.774247,
        -55.822829
      ]
    ]
  },
  {
    "id": "11",
    "territorio": "11",
    "coords": [
      [
        -34.776654,
        -55.824996
      ],
      [
        -34.779404,
        -55.823484
      ],
      [
        -34.780559,
        -55.827152
      ],
      [
        -34.780965,
        -55.828922
      ],
      [
        -34.777518,
        -55.82992
      ],
      [
        -34.777218,
        -55.828257
      ],
      [
        -34.777324,
        -55.827045
      ]
    ]
  },
  {
    "id": "12",
    "territorio": "12",
    "coords": [
      [
        -34.772704,
        -55.826358
      ],
      [
        -34.774908,
        -55.82579
      ],
      [
        -34.775155,
        -55.825908
      ],
      [
        -34.77534,
        -55.825811
      ],
      [
        -34.775437,
        -55.825565
      ],
      [
        -34.77646,
        -55.824985
      ],
      [
        -34.777218,
        -55.827034
      ],
      [
        -34.777253,
        -55.827774
      ],
      [
        -34.777218,
        -55.827925
      ],
      [
        -34.773198,
        -55.828954
      ]
    ]
  },
  {
    "id": "13",
    "territorio": "13",
    "coords": [
      [
        -34.773224,
        -55.828965
      ],
      [
        -34.77728,
        -55.827892
      ],
      [
        -34.7772,
        -55.828257
      ],
      [
        -34.7775,
        -55.829973
      ],
      [
        -34.773595,
        -55.831003
      ]
    ]
  },
  {
    "id": "14",
    "territorio": "14",
    "coords": [
      [
        -34.773595,
        -55.831035
      ],
      [
        -34.774018,
        -55.833642
      ],
      [
        -34.777782,
        -55.832698
      ],
      [
        -34.777337,
        -55.83003
      ]
    ]
  },
  {
    "id": "15",
    "territorio": "15",
    "coords": [
      [
        -34.7778,
        -55.832687
      ],
      [
        -34.777333,
        -55.830027
      ],
      [
        -34.780956,
        -55.829019
      ],
      [
        -34.781617,
        -55.831625
      ]
    ]
  },
  {
    "id": "16",
    "territorio": "16",
    "coords": [
      [
        -34.774027,
        -55.833653
      ],
      [
        -34.77884,
        -55.832419
      ],
      [
        -34.779166,
        -55.834532
      ],
      [
        -34.774441,
        -55.835733
      ]
    ]
  },
  {
    "id": "17",
    "territorio": "17",
    "coords": [
      [
        -34.778849,
        -55.83243
      ],
      [
        -34.781626,
        -55.831668
      ],
      [
        -34.782111,
        -55.833685
      ],
      [
        -34.779166,
        -55.834543
      ]
    ]
  },
  {
    "id": "18",
    "territorio": "18",
    "coords": [
      [
        -34.774423,
        -55.835755
      ],
      [
        -34.775199,
        -55.840046
      ],
      [
        -34.776848,
        -55.839488
      ],
      [
        -34.776116,
        -55.835379
      ]
    ]
  },
  {
    "id": "19",
    "territorio": "19",
    "coords": [
      [
        -34.776142,
        -55.835369
      ],
      [
        -34.779184,
        -55.834586
      ],
      [
        -34.779554,
        -55.83657
      ],
      [
        -34.776495,
        -55.837428
      ]
    ]
  },
  {
    "id": "20",
    "territorio": "20",
    "coords": [
      [
        -34.776522,
        -55.83745
      ],
      [
        -34.779554,
        -55.836624
      ],
      [
        -34.779925,
        -55.838694
      ],
      [
        -34.776848,
        -55.839509
      ]
    ]
  },
  {
    "id": "21",
    "territorio": "21",
    "coords": [
      [
        -34.779925,
        -55.838694
      ],
      [
        -34.779175,
        -55.834543
      ],
      [
        -34.782093,
        -55.833695
      ],
      [
        -34.78286,
        -55.836935
      ],
      [
        -34.783081,
        -55.837836
      ]
    ]
  },
  {
    "id": "22",
    "territorio": "22",
    "coords": [
      [
        -34.774528,
        -55.840288
      ],
      [
        -34.771998,
        -55.840975
      ],
      [
        -34.771257,
        -55.836652
      ],
      [
        -34.772148,
        -55.836405
      ],
      [
        -34.772368,
        -55.836673
      ],
      [
        -34.772606,
        -55.836813
      ],
      [
        -34.772809,
        -55.836759
      ],
      [
        -34.772994,
        -55.836512
      ],
      [
        -34.773118,
        -55.836126
      ],
      [
        -34.77392,
        -55.83588
      ],
      [
        -34.774687,
        -55.839709
      ]
    ]
  },
  {
    "id": "23",
    "territorio": "23",
    "coords": [
      [
        -34.773892,
        -55.835794
      ],
      [
        -34.773073,
        -55.831149
      ],
      [
        -34.770419,
        -55.831954
      ],
      [
        -34.77123,
        -55.836534
      ],
      [
        -34.772129,
        -55.836341
      ],
      [
        -34.772253,
        -55.836019
      ],
      [
        -34.772385,
        -55.835762
      ],
      [
        -34.772579,
        -55.835654
      ],
      [
        -34.772782,
        -55.835729
      ],
      [
        -34.772984,
        -55.835933
      ],
      [
        -34.773073,
        -55.836062
      ]
    ]
  },
  {
    "id": "24",
    "territorio": "24",
    "coords": [
      [
        -34.771962,
        -55.840964
      ],
      [
        -34.769123,
        -55.841704
      ],
      [
        -34.769096,
        -55.841275
      ],
      [
        -34.769105,
        -55.840771
      ],
      [
        -34.769158,
        -55.840288
      ],
      [
        -34.769299,
        -55.839763
      ],
      [
        -34.769441,
        -55.839418
      ],
      [
        -34.769608,
        -55.839012
      ],
      [
        -34.769863,
        -55.838647
      ],
      [
        -34.770225,
        -55.83825
      ],
      [
        -34.770569,
        -55.837918
      ],
      [
        -34.770868,
        -55.837757
      ],
      [
        -34.771124,
        -55.837649
      ],
      [
        -34.771353,
        -55.837553
      ]
    ]
  },
  {
    "id": "25",
    "territorio": "25",
    "coords": [
      [
        -34.769308,
        -55.838819
      ],
      [
        -34.769546,
        -55.839022
      ],
      [
        -34.769854,
        -55.838626
      ],
      [
        -34.770419,
        -55.838025
      ],
      [
        -34.770824,
        -55.837757
      ],
      [
        -34.771318,
        -55.83751
      ],
      [
        -34.770868,
        -55.835064
      ],
      [
        -34.768946,
        -55.835515
      ],
      [
        -34.769325,
        -55.837896
      ],
      [
        -34.769149,
        -55.838046
      ],
      [
        -34.769308,
        -55.838293
      ],
      [
        -34.769334,
        -55.838529
      ]
    ]
  },
  {
    "id": "26",
    "territorio": "26",
    "coords": [
      [
        -34.76959,
        -55.835354
      ],
      [
        -34.77086,
        -55.835032
      ],
      [
        -34.770331,
        -55.831986
      ],
      [
        -34.76907,
        -55.832329
      ]
    ]
  },
  {
    "id": "27",
    "territorio": "27",
    "coords": [
      [
        -34.769017,
        -55.83235
      ],
      [
        -34.767192,
        -55.832855
      ],
      [
        -34.767756,
        -55.835815
      ],
      [
        -34.769546,
        -55.835365
      ]
    ]
  },
  {
    "id": "28",
    "territorio": "28",
    "coords": [
      [
        -34.767175,
        -55.832834
      ],
      [
        -34.765333,
        -55.833359
      ],
      [
        -34.765862,
        -55.836341
      ],
      [
        -34.767731,
        -55.835826
      ]
    ]
  },
  {
    "id": "29",
    "territorio": "29",
    "coords": [
      [
        -34.765888,
        -55.836373
      ],
      [
        -34.76893,
        -55.835537
      ],
      [
        -34.769283,
        -55.837897
      ],
      [
        -34.769133,
        -55.838058
      ],
      [
        -34.768762,
        -55.8381
      ],
      [
        -34.768542,
        -55.838345
      ],
      [
        -34.768524,
        -55.838669
      ],
      [
        -34.768648,
        -55.839023
      ],
      [
        -34.768322,
        -55.840289
      ],
      [
        -34.766708,
        -55.840718
      ],
      [
        -34.766188,
        -55.837886
      ]
    ]
  },
  {
    "id": "30",
    "territorio": "30",
    "coords": [
      [
        -34.769487,
        -55.839045
      ],
      [
        -34.769258,
        -55.838895
      ],
      [
        -34.769073,
        -55.839035
      ],
      [
        -34.768676,
        -55.839131
      ],
      [
        -34.76835,
        -55.840332
      ],
      [
        -34.766736,
        -55.840751
      ],
      [
        -34.767018,
        -55.84236
      ],
      [
        -34.769081,
        -55.841716
      ],
      [
        -34.769055,
        -55.841266
      ],
      [
        -34.769081,
        -55.840826
      ],
      [
        -34.769117,
        -55.840268
      ],
      [
        -34.769222,
        -55.83986
      ],
      [
        -34.769381,
        -55.839431
      ]
    ]
  },
  {
    "id": "31",
    "territorio": "31",
    "coords": [
      [
        -34.765863,
        -55.836353
      ],
      [
        -34.764505,
        -55.836685
      ],
      [
        -34.765149,
        -55.840547
      ],
      [
        -34.765599,
        -55.842692
      ],
      [
        -34.767001,
        -55.84236
      ],
      [
        -34.766383,
        -55.838981
      ]
    ]
  },
  {
    "id": "32",
    "territorio": "32",
    "coords": [
      [
        -34.764505,
        -55.836675
      ],
      [
        -34.76246,
        -55.837275
      ],
      [
        -34.7635,
        -55.843218
      ],
      [
        -34.764276,
        -55.843057
      ],
      [
        -34.76559,
        -55.842692
      ],
      [
        -34.765096,
        -55.840311
      ]
    ]
  },
  {
    "id": "33",
    "territorio": "33",
    "coords": [
      [
        -34.765863,
        -55.836342
      ],
      [
        -34.762451,
        -55.837265
      ],
      [
        -34.761957,
        -55.834272
      ],
      [
        -34.76499,
        -55.83336
      ],
      [
        -34.764338,
        -55.829477
      ],
      [
        -34.766921,
        -55.828855
      ],
      [
        -34.767521,
        -55.832717
      ],
      [
        -34.765316,
        -55.83336
      ]
    ]
  },
  {
    "id": "34",
    "territorio": "34",
    "coords": [
      [
        -34.76417,
        -55.828523
      ],
      [
        -34.764593,
        -55.828415
      ],
      [
        -34.764717,
        -55.828147
      ],
      [
        -34.765175,
        -55.827707
      ],
      [
        -34.765607,
        -55.827482
      ],
      [
        -34.766013,
        -55.827332
      ],
      [
        -34.766595,
        -55.827375
      ],
      [
        -34.765872,
        -55.822998
      ],
      [
        -34.763359,
        -55.823642
      ]
    ]
  },
  {
    "id": "35",
    "territorio": "35",
    "coords": [
      [
        -34.767512,
        -55.832727
      ],
      [
        -34.767168,
        -55.83055
      ],
      [
        -34.769328,
        -55.828576
      ],
      [
        -34.769813,
        -55.82908
      ],
      [
        -34.77036,
        -55.829391
      ],
      [
        -34.769822,
        -55.831558
      ],
      [
        -34.770704,
        -55.831805
      ]
    ]
  },
  {
    "id": "36",
    "territorio": "36",
    "coords": [
      [
        -34.773058,
        -55.831108
      ],
      [
        -34.772211,
        -55.826442
      ],
      [
        -34.771682,
        -55.826592
      ],
      [
        -34.771612,
        -55.827375
      ],
      [
        -34.771092,
        -55.827621
      ],
      [
        -34.770765,
        -55.827621
      ],
      [
        -34.769893,
        -55.829037
      ],
      [
        -34.770404,
        -55.829306
      ],
      [
        -34.769893,
        -55.831483
      ],
      [
        -34.770774,
        -55.83174
      ]
    ]
  },
  {
    "id": "37",
    "territorio": "37",
    "coords": [
      [
        -34.767159,
        -55.830504
      ],
      [
        -34.769249,
        -55.828584
      ],
      [
        -34.768905,
        -55.827919
      ],
      [
        -34.768755,
        -55.827071
      ],
      [
        -34.768737,
        -55.826578
      ],
      [
        -34.768799,
        -55.825934
      ],
      [
        -34.76633,
        -55.825291
      ]
    ]
  },
  {
    "id": "38",
    "territorio": "38",
    "coords": [
      [
        -34.769848,
        -55.828991
      ],
      [
        -34.770748,
        -55.827543
      ],
      [
        -34.771039,
        -55.827543
      ],
      [
        -34.771568,
        -55.827307
      ],
      [
        -34.771576,
        -55.82661
      ],
      [
        -34.772194,
        -55.826331
      ],
      [
        -34.771691,
        -55.823564
      ],
      [
        -34.770897,
        -55.823789
      ],
      [
        -34.769884,
        -55.823338
      ],
      [
        -34.76887,
        -55.825934
      ],
      [
        -34.768781,
        -55.826696
      ],
      [
        -34.768852,
        -55.827447
      ],
      [
        -34.769046,
        -55.82809
      ],
      [
        -34.769337,
        -55.828541
      ]
    ]
  },
  {
    "id": "39",
    "territorio": "39",
    "coords": [
      [
        -34.771665,
        -55.823413
      ],
      [
        -34.771012,
        -55.819563
      ],
      [
        -34.770175,
        -55.819745
      ],
      [
        -34.768815,
        -55.818915
      ],
      [
        -34.768656,
        -55.819387
      ],
      [
        -34.768358,
        -55.820013
      ],
      [
        -34.768376,
        -55.821075
      ],
      [
        -34.768217,
        -55.822266
      ],
      [
        -34.769892,
        -55.823328
      ],
      [
        -34.770889,
        -55.823789
      ],
      [
        -34.771682,
        -55.823553
      ]
    ]
  },
  {
    "id": "40",
    "territorio": "40",
    "coords": [
      [
        -34.76723,
        -55.825441
      ],
      [
        -34.767256,
        -55.824733
      ],
      [
        -34.767812,
        -55.82322
      ],
      [
        -34.768208,
        -55.82233
      ],
      [
        -34.769831,
        -55.823306
      ],
      [
        -34.769407,
        -55.824368
      ],
      [
        -34.769108,
        -55.825237
      ],
      [
        -34.768817,
        -55.825859
      ]
    ]
  },
  {
    "id": "41",
    "territorio": "41",
    "coords": [
      [
        -34.768138,
        -55.822255
      ],
      [
        -34.766216,
        -55.821118
      ],
      [
        -34.765607,
        -55.82129
      ],
      [
        -34.766313,
        -55.825183
      ],
      [
        -34.767168,
        -55.825419
      ],
      [
        -34.767238,
        -55.824679
      ],
      [
        -34.767759,
        -55.823252
      ]
    ]
  },
  {
    "id": "42",
    "territorio": "42",
    "coords": [
      [
        -34.768746,
        -55.818919
      ],
      [
        -34.768332,
        -55.820013
      ],
      [
        -34.768358,
        -55.821043
      ],
      [
        -34.768191,
        -55.822137
      ],
      [
        -34.766251,
        -55.821064
      ],
      [
        -34.765607,
        -55.821225
      ],
      [
        -34.765475,
        -55.820378
      ],
      [
        -34.76551,
        -55.819841
      ],
      [
        -34.765634,
        -55.81923
      ],
      [
        -34.765925,
        -55.818887
      ],
      [
        -34.766269,
        -55.81879
      ],
      [
        -34.766242,
        -55.818522
      ],
      [
        -34.766665,
        -55.817664
      ]
    ]
  },
  {
    "id": "43",
    "territorio": "43",
    "coords": [
      [
        -34.770994,
        -55.819498
      ],
      [
        -34.769963,
        -55.813867
      ],
      [
        -34.769566,
        -55.813974
      ],
      [
        -34.769654,
        -55.814457
      ],
      [
        -34.76842,
        -55.817557
      ],
      [
        -34.767829,
        -55.817718
      ],
      [
        -34.76767,
        -55.81819
      ],
      [
        -34.770201,
        -55.819723
      ]
    ]
  },
  {
    "id": "44",
    "territorio": "44",
    "coords": [
      [
        -34.770051,
        -55.813717
      ],
      [
        -34.769972,
        -55.813309
      ],
      [
        -34.767864,
        -55.813888
      ],
      [
        -34.767494,
        -55.814489
      ],
      [
        -34.766974,
        -55.814832
      ],
      [
        -34.765995,
        -55.815862
      ],
      [
        -34.76618,
        -55.817364
      ],
      [
        -34.767565,
        -55.8182
      ],
      [
        -34.767829,
        -55.817664
      ],
      [
        -34.768376,
        -55.817482
      ],
      [
        -34.76961,
        -55.814435
      ],
      [
        -34.769513,
        -55.813974
      ]
    ]
  },
  {
    "id": "45",
    "territorio": "45",
    "coords": [
      [
        -34.763361,
        -55.823637
      ],
      [
        -34.765838,
        -55.822961
      ],
      [
        -34.765424,
        -55.82043
      ],
      [
        -34.765459,
        -55.819969
      ],
      [
        -34.765538,
        -55.819454
      ],
      [
        -34.7659,
        -55.818864
      ],
      [
        -34.766226,
        -55.818714
      ],
      [
        -34.766217,
        -55.818467
      ],
      [
        -34.766641,
        -55.81763
      ],
      [
        -34.765732,
        -55.817158
      ],
      [
        -34.765371,
        -55.817255
      ],
      [
        -34.765186,
        -55.819153
      ],
      [
        -34.762752,
        -55.819958
      ]
    ]
  },
  {
    "id": "46",
    "territorio": "46",
    "coords": [
      [
        -34.762743,
        -55.819958
      ],
      [
        -34.762197,
        -55.815989
      ],
      [
        -34.763784,
        -55.815624
      ],
      [
        -34.763907,
        -55.815163
      ],
      [
        -34.766023,
        -55.81644
      ],
      [
        -34.766138,
        -55.817362
      ],
      [
        -34.765741,
        -55.817115
      ],
      [
        -34.765345,
        -55.817233
      ],
      [
        -34.765142,
        -55.819164
      ]
    ]
  },
  {
    "id": "47",
    "territorio": "47",
    "coords": [
      [
        -34.767813,
        -55.813887
      ],
      [
        -34.767346,
        -55.810175
      ],
      [
        -34.765283,
        -55.811602
      ],
      [
        -34.765953,
        -55.815893
      ],
      [
        -34.766585,
        -55.81516
      ],
      [
        -34.766876,
        -55.814935
      ],
      [
        -34.767178,
        -55.814605
      ],
      [
        -34.767505,
        -55.814455
      ]
    ]
  }
];

    /*************** UTILIDADES ***************/
    function diferenciaEnMeses(a, b) {
      return (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
    }
    function quitarTildes(s) {
      return s.normalize?.('NFD').replace(/\p{Diacritic}/gu, '') || s;
    }
    function parseCSVLine(line) {
      const out = []; let cur = '', inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { if (inQ && line[i+1] === '"') { cur += '"'; i++; } else { inQ = !inQ; } }
        else if (ch === ',' && !inQ) { out.push(cur); cur = ''; }
        else { cur += ch; }
      }
      out.push(cur); return out;
    }
    function parseFechaSeguro(s) {
      s = String(s || '').trim();
      if (!s) return new Date('Invalid');
      const d1 = new Date(s);
      if (!isNaN(d1)) return d1;
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m) return new Date(+m[3], +m[2]-1, +m[1]);
      return new Date('Invalid');
    }
    function normalizarFinalizado(v) {
      const s = String(v ?? '').trim().toLowerCase();
      if (!s) return '';
      if (['si','s√≠','s','true','1','ok','finalizado','completo','terminado'].includes(s)) return 'Si';
      if (['no','n','false','0','pendiente','incompleto'].includes(s)) return 'No';
      return s;
    }
    function obtenerColor(fecha, finalizado) {
      if (!(fecha instanceof Date) || isNaN(fecha)) return 'gray';
      const ahora = new Date();
      const diffMeses = diferenciaEnMeses(fecha, ahora);
      const fin = String(finalizado ?? '').trim().toLowerCase();
      const esSi = ['si','s√≠','true','1','ok','finalizado','completo','terminado'].includes(fin) || finalizado === true;
      if (diffMeses < 2 && !esSi) return 'blue';
      if (diffMeses < 2 && esSi)  return 'green';
      if (diffMeses <= 3)         return 'yellow';
      if (diffMeses > 3)          return 'red';
      return 'gray';
    }
    function actualizarContadores() {
      document.getElementById('contador-azul').textContent = contadores.blue;
      document.getElementById('contador-verde').textContent = contadores.green;
      document.getElementById('contador-amarillo').textContent = contadores.yellow;
      document.getElementById('contador-rojo').textContent = contadores.red;
    }

    /*************** FETCH CSV ROBUSTO (con fallbacks CORS) ***************/
    async function fetchTextWithFallback(sheetCsvUrl) {
      // Intento directo (sirve si us√°s Live Server/localhost y Google permite CORS)
      try {
        const res = await fetch(sheetCsvUrl, { redirect: 'follow', headers: { 'Accept': 'text/csv' } });
        if (res.ok) {
          const txt = await res.text();
          if (txt && txt.trim() !== '') return txt;
        }
      } catch (_) {}

      // Proxies p√∫blicos (ordenados por confiabilidad percibida)
      const candidates = [
        // AllOrigins
        'https://api.allorigins.win/raw?url=' + encodeURIComponent(sheetCsvUrl),
        // cors.isomorphic-git.org
        'https://cors.isomorphic-git.org/' + sheetCsvUrl,
        // r.jina.ai (http/https)
        'https://r.jina.ai/http://'  + sheetCsvUrl.replace(/^https?:\/\//,''),
        'https://r.jina.ai/https://' + sheetCsvUrl.replace(/^https?:\/\//,'')
      ];

      for (const url of candidates) {
        try {
          const res = await fetch(url, { redirect: 'follow' });
          if (res.ok) {
            const txt = await res.text();
            if (txt && txt.trim() !== '') return txt;
          }
        } catch (e) {
          console.warn('Proxy fall√≥:', url, e);
        }
      }

      throw new Error('No se pudo obtener el CSV (CORS/proxy). Sugerencia: serv√≠ el HTML en http://localhost y/o crea un WebApp en Apps Script como proxy.');
    }

    function indicesPorEncabezado(headers) {
      const norm = headers.map(h => quitarTildes(String(h||'').trim().toLowerCase()));
      const lookup = (...aliases) => {
        const aliNorm = aliases.map(a => quitarTildes(a.toLowerCase()));
        for (let i = 0; i < norm.length; i++) if (aliNorm.includes(norm[i])) return i;
        return -1;
      };
      return {
        id: lookup('id','identificador','territorio'),
        fecha: lookup('ultima fecha','√∫ltima fecha','fecha','fecha ultima','fecha √∫ltima'),
        finalizado: lookup('finalizado','se finalizo el territorio','se finaliz√≥ el territorio','¬øse finaliz√≥?','se finalizo','se finaliz√≥','estado')
      };
    }

    async function cargarDatosDesdeSheets() {
      try {
        const csvData = await fetchTextWithFallback(SHEET_CSV); // üîß usa fallbacks CORS
        const filas = csvData.split(/\r?\n/).filter(l => l.trim() !== '');
        if (filas.length === 0) return [];
        const headerCols = parseCSVLine(filas[0]);
        let start = 0;
        let idxId = 0, idxFecha = 1, idxFin = 2;

        const joined = headerCols.join(',').toLowerCase();
        const looksHeader = /id|fecha|finaliz/.test(joined);
        if (looksHeader) {
          const { id, fecha, finalizado } = indicesPorEncabezado(headerCols);
          if (id !== -1) idxId = id;
          if (fecha !== -1) idxFecha = fecha;
          if (finalizado !== -1) idxFin = finalizado;
          start = 1;
        }

        const datos = [];
        for (let i = start; i < filas.length; i++) {
          const cols = parseCSVLine(filas[i]);
          const idStr = (cols[idxId] ?? '').trim();
          const fechaStr = (cols[idxFecha] ?? '').trim();
          const finStr = (cols[idxFin] ?? '').trim();

          // üîß Guardamos id tambi√©n como string para comparar con poligonos
          const idNum = parseInt(idStr, 10);
          const id = Number.isInteger(idNum) ? idNum : idStr; // conserva no num√©ricos
          const fecha = parseFechaSeguro(fechaStr);
          const finalizado = normalizarFinalizado(finStr);

          if ((idStr !== '') && fecha instanceof Date && !isNaN(fecha)) {
            datos.push({ id, fecha, finalizado });
          }
        }
        return datos;
      } catch (error) {
        console.error('Error cargando datos desde Google Sheets:', error);
        return [];
      }
    }

    /*************** UI: panel info ***************/
    const infoPanel = document.getElementById('info-panel');
    const polygonId = document.getElementById('polygon-id');
    const polygonFecha = document.getElementById('polygon-fecha');

    /*************** CARGA DEL MAPA ***************/
    async function cargarMapa() {
      const datosSheets = await cargarDatosDesdeSheets();

      contadores = { blue: 0, green: 0, yellow: 0, red: 0 };

      poligonos.forEach(p => {
        // üîß match por string para evitar "32" vs 32
        const dato = datosSheets.find(d => String(d.id) === String(p.id));
        p.fecha = dato ? dato.fecha : null;
        p.finalizado = dato ? dato.finalizado : '';

        const colorInicial = obtenerColor(p.fecha, p.finalizado);
        if (contadores[colorInicial] != null) contadores[colorInicial]++;

        const poly = L.polygon(p.coords, {
          color: 'black',
          fillColor: colorInicial,
          fillOpacity: 0.5
        }).addTo(map);

        const tooltipContent = `
          <div class="tooltip-content">
            <div><strong>${p.id}</strong></div>
          </div>
        `;
        poly.bindTooltip(tooltipContent, { permanent: true, direction: 'center', className: 'label' });

        poly.on('click', function () {
          infoPanel.style.display = 'block';
          polygonId.textContent = p.id;
          polygonFecha.textContent =
            (p.fecha instanceof Date && !isNaN(p.fecha)) ? p.fecha.toLocaleDateString() : 'Fecha no disponible';
        });
      });

      actualizarContadores();
    }

    /*************** RANKING (SIN HACER, M√ÅS ANTIGUOS) ***************/
    async function mostrarRanking() {
      try {
        const datosSheets = await cargarDatosDesdeSheets();
        if (!Array.isArray(datosSheets) || datosSheets.length === 0) {
          document.getElementById('ranking-container').innerHTML =
            '<h3>Territorios sin hacer</h3><p>No se pudieron cargar datos.</p>';
          return;
        }

        // Finalizado != 'Si'
        const sinHacer = datosSheets.filter(d => String(d.finalizado).toLowerCase() !== 'si');

        // Ordenar por fecha (m√°s antigua primero)
        sinHacer.sort((a, b) => a.fecha - b.fecha);

        const lista = sinHacer.slice(0, N_RANK);

        let html = '<h3>Territorios sin hacer</h3><ul>';
        const hoy = new Date();
        for (const d of lista) {
          const fechaTxt = (d.fecha instanceof Date && !isNaN(d.fecha)) ? d.fecha.toLocaleDateString() : '-';
          const meses = (d.fecha instanceof Date && !isNaN(d.fecha)) ? diferenciaEnMeses(d.fecha, hoy) : '?';
          html += `<li>${d.id} - ${fechaTxt} (${meses} mes${meses===1?'':'es'})</li>`;
        }
        html += '</ul>';

        document.getElementById('ranking-container').innerHTML = html;
      } catch (e) {
        console.error(e);
        document.getElementById('ranking-container').innerHTML =
          '<h3>Territorios sin hacer</h3><p>Error al cargar datos.</p>';
      }
    }

    /*************** INIT ***************/
    mostrarRanking();
    cargarMapa();

    // (Opcional) refrescar cada 5 minutos:
    // setInterval(() => { mostrarRanking(); /* y si quer√©s: recargar mapa */ }, 5 * 60 * 1000);
  </script>
</body>
</html>
